<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculadora Shopee Pro</title>
    
    <!-- 1. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 2. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 4. Lucide Icons (Versão Vanilla - Mais estável para CDN) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 5. MÓDULO FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC8oUxh-C3YELINAJy5nbwYqXcIv55Ch00",
            authDomain: "shopee-v2-fb079.firebaseapp.com",
            projectId: "shopee-v2-fb079",
            storageBucket: "shopee-v2-fb079.firebasestorage.app",
            messagingSenderId: "978626968094",
            appId: "1:978626968094:web:fe04205ab18aa44dd3cc0f"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            window.AppServices = { 
                db, auth, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp,
                onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut
            };
            console.log("Firebase inicializado.");
        } catch (e) {
            console.error("Erro Firebase:", e);
        }
    </script>

    <!-- 6. CÓDIGO DA APLICAÇÃO -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const appId = 'shopee-calc-app';

        // --- COMPONENTE DE ÍCONES (SOLUÇÃO PARA O ERRO) ---
        // Converte nomes de ícones (ex: "dollar-sign") em SVG usando a lib global
        const IconWrapper = ({ name, size = 24, className = "" }) => {
            const ref = useRef(null);
            
            useEffect(() => {
                if (window.lucide && ref.current) {
                    const iconName = name.replace(/([A-Z])/g, "-$1").toLowerCase().replace(/^-/, ""); // PascalCase to kebab-case fallback
                    // A lib Lucide vanilla usa createIcons ou icons diretamente
                    // Vamos criar o SVG manualmente usando a API da Lucide se disponível
                    if(window.lucide.icons[name]) {
                         // Limpa e recria
                         ref.current.innerHTML = '';
                         const svg = window.lucide.createElement(window.lucide.icons[name]);
                         svg.setAttribute('width', size);
                         svg.setAttribute('height', size);
                         if(className) svg.setAttribute('class', className);
                         ref.current.appendChild(svg);
                    } else {
                        // Tenta pelo nome Kebab-case se Pascal falhar
                        const kebab = name.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g, '$1-$2').toLowerCase();
                         if(window.lucide.icons[kebab]) {
                             ref.current.innerHTML = '';
                             const svg = window.lucide.createElement(window.lucide.icons[kebab]);
                             svg.setAttribute('width', size);
                             svg.setAttribute('height', size);
                             if(className) svg.setAttribute('class', className);
                             ref.current.appendChild(svg);
                         }
                    }
                }
            }, [name, size, className]);

            return <span ref={ref} className="inline-flex items-center justify-center"></span>;
        };

        // --- COMPONENTE AUXILIAR INPUT ---
        const InputGroup = ({ label, value, setValue, isPercent = false, iconName }) => (
            <div>
                <label className="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wider">{label}</label>
                <div className="relative group">
                    <div className="absolute left-3 top-3 text-slate-400 group-focus-within:text-orange-500 transition-colors">
                        <IconWrapper name={iconName || (isPercent ? "Percent" : "DollarSign")} size={14} />
                    </div>
                    <input 
                        type="number" 
                        value={value} 
                        onChange={(e) => setValue(Number(e.target.value))}
                        onFocus={(e) => e.target.select()}
                        className="w-full bg-slate-50 border border-slate-200 rounded-lg py-2.5 pl-9 pr-4 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:bg-white transition-all font-semibold text-slate-700 text-sm"
                    />
                    {isPercent && <span className="absolute right-3 top-3 text-slate-400 text-xs font-bold">%</span>}
                </div>
            </div>
        );

        // --- COMPONENTE PRINCIPAL ---
        const ShopeeCalculator = () => {
            // Estados de Dados
            const [editingId, setEditingId] = useState(null); 
            const [nomeProduto, setNomeProduto] = useState(""); 
            const [custoProduto, setCustoProduto] = useState(50.00);
            const [freteInterno, setFreteInterno] = useState(0.00);
            const [embalagem, setEmbalagem] = useState(0.50);
            const [outrosCustos, setOutrosCustos] = useState(0.00);
            const [temFreteGratis, setTemFreteGratis] = useState(true);
            const [imposto, setImposto] = useState(4.00);
            const [margemDesejada, setMargemDesejada] = useState(20.00);
            const [descontoPercentual, setDescontoPercentual] = useState(25); 

            // Estados de Sistema
            const [user, setUser] = useState(null);
            const [loadingAuth, setLoadingAuth] = useState(true);
            const [showLoginScreen, setShowLoginScreen] = useState(true);
            const [activeTab, setActiveTab] = useState('calc'); 
            const [produtosSalvos, setProdutosSalvos] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            
            // Auth States
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [isRegistering, setIsRegistering] = useState(false);
            const [authError, setAuthError] = useState("");
            const [saveStatus, setSaveStatus] = useState('idle');

            // --- 1. AUTENTICAÇÃO ---
            useEffect(() => {
                const checkServices = setInterval(() => {
                    if (window.AppServices && window.AppServices.auth) {
                        clearInterval(checkServices);
                        initAuthListener();
                    }
                }, 100);

                const initAuthListener = () => {
                    const { auth, onAuthStateChanged } = window.AppServices;
                    onAuthStateChanged(auth, (currentUser) => {
                        setUser(currentUser);
                        if (currentUser) {
                            setShowLoginScreen(false);
                        }
                        setLoadingAuth(false);
                    });
                };
                return () => clearInterval(checkServices);
            }, []);

            // --- 2. LISTENER DE PRODUTOS ---
            useEffect(() => {
                if (!user || !window.AppServices) {
                    setProdutosSalvos([]);
                    return;
                }
                const { db, collection, query, orderBy, onSnapshot } = window.AppServices;

                const q = query(
                    collection(db, 'artifacts', appId, 'users', user.uid, 'products'),
                    orderBy('lastUpdated', 'desc')
                );
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const lista = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProdutosSalvos(lista);
                }, (error) => console.error("Erro ao buscar:", error));
                
                return () => unsubscribe();
            }, [user]);

            // --- FUNÇÕES DE AUTH ---
            const handleAuthAction = async (e) => {
                e.preventDefault();
                setLoadingAuth(true);
                setAuthError("");
                if (!window.AppServices) return;
                const { auth, signInWithEmailAndPassword, createUserWithEmailAndPassword } = window.AppServices;

                try {
                    if (isRegistering) await createUserWithEmailAndPassword(auth, email, password);
                    else await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    setAuthError("Erro ao autenticar. Verifique seus dados.");
                    setLoadingAuth(false);
                }
            };

            const handleLogout = async () => {
                if (!window.AppServices) return;
                const { auth, signOut } = window.AppServices;
                await signOut(auth);
                handleNewProduct();
                setShowLoginScreen(true);
            };

            // --- FUNÇÕES CRUD ---
            const handleNewProduct = () => {
                setEditingId(null);
                setNomeProduto("");
                setCustoProduto(50.00);
                setFreteInterno(0.00);
                setEmbalagem(0.50);
                setOutrosCustos(0.00);
                setTemFreteGratis(true);
                setImposto(4.00);
                setMargemDesejada(20.00);
                setDescontoPercentual(25);
                setSaveStatus('idle');
                setActiveTab('calc');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleSave = async () => {
                if (!user) return;
                if (!nomeProduto.trim()) {
                    alert("Digite um nome para o produto antes de salvar.");
                    return;
                }
                setSaveStatus('saving');
                const { db, doc, updateDoc, addDoc, collection, serverTimestamp } = window.AppServices;

                try {
                    const productData = {
                        nomeProduto,
                        custoProduto,
                        freteInterno,
                        embalagem,
                        outrosCustos,
                        temFreteGratis,
                        imposto,
                        margemDesejada,
                        descontoPercentual,
                        lastUpdated: serverTimestamp(),
                        summary: { precoVenda, lucroLiquido }
                    };

                    if (editingId) {
                        await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'products', editingId), productData);
                    } else {
                        const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'products'), productData);
                        setEditingId(docRef.id);
                    }
                    setSaveStatus('saved');
                    setTimeout(() => setSaveStatus('idle'), 2000);
                } catch (error) {
                    console.error("Erro ao salvar:", error);
                    setSaveStatus('error');
                }
            };

            const handleEdit = (prod) => {
                setEditingId(prod.id);
                setNomeProduto(prod.nomeProduto || "");
                setCustoProduto(Number(prod.custoProduto));
                setFreteInterno(Number(prod.freteInterno));
                setEmbalagem(Number(prod.embalagem));
                setOutrosCustos(Number(prod.outrosCustos));
                setTemFreteGratis(Boolean(prod.temFreteGratis));
                setImposto(Number(prod.imposto));
                setMargemDesejada(Number(prod.margemDesejada));
                setDescontoPercentual(Number(prod.descontoPercentual));
                setActiveTab('calc');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleDelete = async (id, e) => {
                e.stopPropagation();
                if (!window.confirm("Excluir este produto?")) return;
                const { db, doc, deleteDoc } = window.AppServices;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'products', id));
                    if (editingId === id) handleNewProduct();
                } catch (error) { console.error(error); }
            };

            // --- CÁLCULOS ---
            const handleNameChange = (e) => setNomeProduto(e.target.value.replace(/(^\w|\s\w)/g, m => m.toUpperCase()));

            const taxaShopeePorcentagem = temFreteGratis ? 20 : 14; 
            const taxaFixa = 4.00; 
            const custoTotal = Number(custoProduto) + Number(freteInterno) + Number(embalagem) + Number(outrosCustos);
            
            // Cálculo Principal
            const divisor = 1 - ((taxaShopeePorcentagem + Number(imposto) + Number(margemDesejada)) / 100);
            const precoVenda = divisor > 0 ? (custoTotal + taxaFixa) / divisor : 0;
            const precoPlataforma = precoVenda > 0 ? precoVenda / (1 - (descontoPercentual / 100)) : 0;
            const descontoRelampagoPercentual = Number(descontoPercentual) + 1; 
            const precoRelampago = precoPlataforma * (1 - (descontoRelampagoPercentual / 100));

            const valorTaxaShopee = (precoVenda * taxaShopeePorcentagem / 100) + taxaFixa;
            const valorImposto = precoVenda * (Number(imposto) / 100);
            const lucroLiquido = precoVenda - custoTotal - valorTaxaShopee - valorImposto;
            const lucroRelampago = precoRelampago - custoTotal - ((precoRelampago * taxaShopeePorcentagem / 100) + taxaFixa) - (precoRelampago * (Number(imposto)/100));

            const cpaMaximo = lucroLiquido; 
            const roasMinimo = cpaMaximo > 0 ? precoVenda / cpaMaximo : 0;
            const roasIdeal = roasMinimo * 1.5;
            const roasExcelente = roasMinimo * 2;
            const cpaIdeal = cpaMaximo / 2;

            // --- FUNÇÃO DE SIMULAÇÃO ---
            const calcularPrecoLucroPorMargem = (margemSimulada) => {
                const divisorSimulado = 1 - ((taxaShopeePorcentagem + Number(imposto) + Number(margemSimulada)) / 100);
                const precoVendaSimulado = divisorSimulado > 0 ? (custoTotal + taxaFixa) / divisorSimulado : 0;
                
                const valorTaxaShopeeSimulado = (precoVendaSimulado * taxaShopeePorcentagem / 100) + taxaFixa;
                const valorImpostoSimulado = precoVendaSimulado * (Number(imposto) / 100);
                const lucroLiquidoSimulado = precoVendaSimulado - custoTotal - valorTaxaShopeeSimulado - valorImpostoSimulado;

                return {
                    precoVenda: precoVendaSimulado,
                    lucroLiquido: lucroLiquidoSimulado
                };
            };

            const formatCurrency = (value) => {
                if (isNaN(value) || !isFinite(value)) return "R$ 0,00";
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            };

            const aplicarNivel = (novaMargem) => {
                const novoDivisor = 1 - ((taxaShopeePorcentagem + Number(imposto) + Number(novaMargem)) / 100);
                const novoPrecoVenda = novoDivisor > 0 ? (custoTotal + taxaFixa) / novoDivisor : 0;
                if (precoPlataforma > 0 && novoPrecoVenda > 0) {
                    const novoDesconto = (1 - (novoPrecoVenda / precoPlataforma)) * 100;
                    if (novoDesconto >= 0 && novoDesconto < 99) {
                        setDescontoPercentual(Number(novoDesconto.toFixed(1)));
                    }
                }
                setMargemDesejada(novaMargem);
            };

            // --- TELA DE LOGIN ---
            if (showLoginScreen) {
                return (
                    <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                        <div className="bg-white max-w-md w-full rounded-2xl shadow-xl border border-slate-200 p-8 animate-fade-in">
                            <div className="flex justify-center mb-6">
                                <div className="bg-orange-100 p-4 rounded-full"><IconWrapper name="Calculator" size={48} className="text-orange-600" /></div>
                            </div>
                            <div className="text-center mb-8">
                                <h1 className="text-2xl font-bold text-slate-800">Calculadora Shopee Pro</h1>
                                <p className="text-slate-500 text-sm mt-1">Sua precificação salva na nuvem.</p>
                            </div>
                            <form onSubmit={handleAuthAction} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">E-mail</label>
                                    <div className="relative">
                                        <div className="absolute left-3 top-3 text-slate-400"><IconWrapper name="Mail" size={20} /></div>
                                        <input type="email" required value={email} onChange={(e) => setEmail(e.target.value)} className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-300 focus:ring-2 focus:ring-orange-500 outline-none" placeholder="seu@email.com"/>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Senha</label>
                                    <div className="relative">
                                        <div className="absolute left-3 top-3 text-slate-400"><IconWrapper name="Lock" size={20} /></div>
                                        <input type="password" required minLength={6} value={password} onChange={(e) => setPassword(e.target.value)} className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-300 focus:ring-2 focus:ring-orange-500 outline-none" placeholder="******"/>
                                    </div>
                                </div>
                                {authError && <div className="p-3 bg-red-50 text-red-600 text-xs rounded-lg flex items-center gap-2"><IconWrapper name="AlertTriangle" size={14} /> {authError}</div>}
                                <button type="submit" disabled={loadingAuth} className="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-orange-200 flex items-center justify-center gap-2">
                                    {loadingAuth ? <IconWrapper name="Loader2" size={20} className="animate-spin" /> : (isRegistering ? "Criar Conta" : "Entrar")}
                                </button>
                            </form>
                            <div className="mt-6 text-center">
                                <button onClick={() => { setIsRegistering(!isRegistering); setAuthError(""); }} className="text-sm text-slate-500 hover:text-orange-600 font-medium">{isRegistering ? "Já tem uma conta? Faça Login" : "Não tem conta? Crie agora"}</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- APP PRINCIPAL ---
            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-20 animate-fade-in">
                    
                    {/* HEADER */}
                    <div className="bg-white border-b border-slate-200 sticky top-0 z-50">
                        <div className="max-w-6xl mx-auto px-4 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <div className="bg-orange-500 text-white p-2 rounded-lg"><IconWrapper name="Calculator" size={20} /></div>
                                    <h1 className="text-xl font-bold text-slate-900 hidden sm:block">Shopee Pro</h1>
                                    <div className="flex bg-slate-100 rounded-lg p-1 ml-4">
                                        <button onClick={() => setActiveTab('calc')} className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${activeTab === 'calc' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>Calculadora</button>
                                        <button onClick={() => setActiveTab('list')} className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${activeTab === 'list' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>Meus Produtos</button>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className="text-[10px] text-slate-400 font-bold uppercase hidden md:inline mr-2">{user?.email}</span>
                                    <button onClick={handleLogout} className="text-slate-400 hover:text-red-500 p-1.5 rounded-lg hover:bg-red-50" title="Sair"><IconWrapper name="LogOut" size={18} /></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-6xl mx-auto p-4 md:p-8 space-y-8">

                        {activeTab === 'calc' && (
                            <>
                                {/* TÍTULO */}
                                <div className="flex flex-col md:flex-row gap-4 items-start md:items-end justify-between border-b border-slate-200 pb-4">
                                    <div className="w-full md:w-2/3">
                                        <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">{editingId ? "Editando Produto:" : "Novo Cálculo:"}</label>
                                        <input type="text" value={nomeProduto} onChange={handleNameChange} placeholder="Digite o nome do produto aqui..." className="w-full text-2xl md:text-3xl font-bold text-slate-800 placeholder:text-slate-300 border-none bg-transparent focus:ring-0 p-0" />
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button onClick={handleNewProduct} className="text-slate-400 hover:text-slate-600 p-2 rounded-full hover:bg-slate-100" title="Limpar / Novo"><IconWrapper name="PlusCircle" size={20} /></button>
                                        <button onClick={handleSave} disabled={saveStatus === 'saving'} className={`flex items-center gap-2 px-6 py-2 rounded-full font-bold text-white shadow-lg shadow-orange-100 transition-all active:scale-95 disabled:opacity-70 ${saveStatus === 'saved' ? 'bg-green-500' : 'bg-orange-500 hover:bg-orange-600'}`}>
                                            {saveStatus === 'saving' ? <IconWrapper name="Loader2" size={18} className="animate-spin" /> : <IconWrapper name="Save" size={18} />}
                                            {saveStatus === 'saving' ? "..." : (saveStatus === 'saved' ? "Salvo!" : "Salvar")}
                                        </button>
                                    </div>
                                </div>

                                {/* CARDS INPUTS */}
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
                                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                                        <div className="flex items-center gap-3 mb-6"><div className="p-2 bg-orange-50 rounded-lg"><IconWrapper name="Package" className="text-orange-500" size={24} /></div><div><h2 className="font-bold text-lg">Custos</h2><p className="text-xs text-slate-400">Gastos diretos</p></div></div>
                                        <div className="space-y-4">
                                            <InputGroup label="Custo do Produto" value={custoProduto} setValue={setCustoProduto} iconName="DollarSign" />
                                            <InputGroup label="Frete Interno" value={freteInterno} setValue={setFreteInterno} iconName="Truck" />
                                            <InputGroup label="Embalagem" value={embalagem} setValue={setEmbalagem} iconName="Package" />
                                            <InputGroup label="Outros Custos" value={outrosCustos} setValue={setOutrosCustos} iconName="DollarSign" />
                                        </div>
                                        <div className="mt-6 pt-4 border-t border-dashed border-slate-200 flex justify-between items-center"><span className="text-slate-500 font-medium text-sm">Custo Total</span><span className="text-xl font-bold text-orange-600">{formatCurrency(custoTotal)}</span></div>
                                    </div>

                                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                                        <div className="flex items-center gap-3 mb-6"><div className="p-2 bg-yellow-50 rounded-lg"><IconWrapper name="DollarSign" className="text-yellow-600" size={24} /></div><div><h2 className="font-bold text-lg">Taxas</h2><p className="text-xs text-slate-400">Comissões</p></div></div>
                                        <div className="space-y-5">
                                            <div className="grid grid-cols-2 gap-3">
                                                <button onClick={() => setTemFreteGratis(true)} className={`p-3 rounded-xl border text-sm font-medium transition-all relative ${temFreteGratis ? 'border-orange-500 bg-orange-50 text-orange-700' : 'border-slate-200 text-slate-500 hover:border-orange-200'}`}>{temFreteGratis && <div className="absolute top-2 right-2 w-2 h-2 bg-orange-500 rounded-full"></div>} Frete Grátis <span className="block text-[10px] opacity-80">~20%</span></button>
                                                <button onClick={() => setTemFreteGratis(false)} className={`p-3 rounded-xl border text-sm font-medium transition-all relative ${!temFreteGratis ? 'border-orange-500 bg-orange-50 text-orange-700' : 'border-slate-200 text-slate-500 hover:border-orange-200'}`}>{!temFreteGratis && <div className="absolute top-2 right-2 w-2 h-2 bg-orange-500 rounded-full"></div>} Clássico <span className="block text-[10px] opacity-80">~14%</span></button>
                                            </div>
                                            <InputGroup label="Imposto (DAS) %" value={imposto} setValue={setImposto} isPercent />
                                            <div className="bg-slate-50 p-3 rounded-lg border border-slate-200 text-sm space-y-2">
                                                <div className="flex justify-between items-center"><span className="text-slate-500 text-xs">Taxa Fixa</span> <span className="font-medium text-slate-700">R$ {taxaFixa.toFixed(2)}</span></div>
                                                <div className="flex justify-between items-center"><span className="text-slate-500 text-xs">Comissão</span> <span className="font-medium text-slate-700">{taxaShopeePorcentagem}%</span></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 relative overflow-hidden">
                                        <div className="absolute top-0 right-0 w-24 h-24 bg-green-50 rounded-bl-full -z-0 opacity-50"></div>
                                        <div className="flex items-center gap-3 mb-6 relative z-10"><div className="p-2 bg-green-50 rounded-lg"><IconWrapper name="Percent" className="text-green-600" size={24} /></div><div><h2 className="font-bold text-lg">Margem</h2><p className="text-xs text-slate-400">Lucro Líquido</p></div></div>
                                        <div className="space-y-6 relative z-10">
                                            <InputGroup label="Margem Desejada (%)" value={margemDesejada} setValue={setMargemDesejada} isPercent />
                                            <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 border border-green-100 mt-auto">
                                                <p className="text-xs text-green-800 mb-1 font-bold uppercase"><IconWrapper name="CheckCircle2" size={12} className="inline mr-1"/> Lucro Líquido</p>
                                                <p className="text-3xl font-bold text-green-600 tracking-tight">{formatCurrency(lucroLiquido)}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* RESULTADO PREÇO FINAL */}
                                <div className="bg-slate-900 rounded-2xl shadow-xl p-6 md:p-8 text-white relative overflow-hidden">
                                    <div className="absolute top-0 right-0 w-64 h-64 bg-orange-500 rounded-full blur-[80px] opacity-20"></div>
                                    <div className="flex flex-col md:flex-row items-center justify-between gap-8 relative z-10">
                                        <div className="flex-1 space-y-2 hidden md:block opacity-80 text-sm">
                                            <div className="flex justify-between border-b border-white/10 pb-1"><span>Custo Total</span> <span>{formatCurrency(custoTotal)}</span></div>
                                            <div className="flex justify-between border-b border-white/10 pb-1"><span>Taxas Shopee</span> <span className="text-red-300">- {formatCurrency(valorTaxaShopee)}</span></div>
                                            <div className="flex justify-between border-b border-white/10 pb-1"><span>Imposto ({imposto}%)</span> <span className="text-red-300">- {formatCurrency(valorImposto)}</span></div>
                                            <div className="flex justify-between pt-1 font-bold text-white"><span>Lucro Líquido</span> <span className="text-green-400">{formatCurrency(lucroLiquido)}</span></div>
                                        </div>
                                        <div className="flex flex-col items-center justify-center flex-[1.5] text-center">
                                            <span className="text-xs font-bold text-orange-400 uppercase tracking-widest mb-2 flex items-center gap-2"><IconWrapper name="Tag" size={14} /> Preço Ideal de Venda</span>
                                            <div className="text-5xl md:text-6xl font-extrabold text-white tracking-tight drop-shadow-lg">{formatCurrency(precoVenda)}</div>
                                            <span className="text-sm text-slate-400 mt-3 bg-white/10 px-4 py-1 rounded-full">Garante {margemDesejada}% de margem limpa</span>
                                        </div>
                                        <div className="flex-1 flex justify-end">
                                            <div className="bg-white/10 backdrop-blur-sm p-3 rounded-xl border border-white/10 text-right">
                                                <p className="text-[10px] text-slate-400 mb-1 uppercase">ROI Estimado</p>
                                                <p className="text-2xl font-bold text-emerald-400">{custoTotal > 0 ? ((lucroLiquido / custoTotal) * 100).toFixed(1) : 0}%</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* ESTRATÉGIA */}
                                <div className="space-y-6">
                                    <div className="flex items-center justify-between">
                                        <h3 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><IconWrapper name="Tag" className="text-orange-500" size={24} /> Estratégia de Cadastro</h3>
                                        <div className="w-48"><InputGroup label="Desconto De/Por (%)" value={descontoPercentual} setValue={setDescontoPercentual} isPercent iconName="Percent" /></div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden group hover:border-orange-300 transition-colors">
                                            <div className="absolute top-0 left-0 w-1.5 h-full bg-slate-300 group-hover:bg-orange-400 transition-colors"></div>
                                            <p className="font-bold text-slate-700 mb-1">Preço "De" (Cadastro)</p>
                                            <p className="text-xs text-slate-400 mb-4">Valor cheio inflado para aplicar cupom</p>
                                            <div className="text-3xl font-bold text-slate-400 line-through decoration-orange-500 decoration-2">{formatCurrency(precoPlataforma)}</div>
                                        </div>
                                        <div className="bg-white p-6 rounded-2xl border-2 border-orange-400 shadow-lg relative transform md:-translate-y-2">
                                            <div className="absolute top-3 right-3 bg-orange-100 text-orange-700 text-xs font-bold px-2 py-1 rounded-full">-{Number(descontoPercentual).toFixed(0)}% OFF</div>
                                            <p className="font-bold text-slate-800 mb-1">Preço "Por" (Cliente)</p>
                                            <p className="text-xs text-slate-500 mb-4">Valor real que o cliente paga</p>
                                            <div className="text-4xl font-bold text-orange-600">{formatCurrency(precoVenda)}</div>
                                            <div className="mt-4 pt-4 border-t border-dashed border-orange-100 flex items-center gap-2 text-sm text-orange-800"><IconWrapper name="CheckCircle2" size={16} /> É o seu preço ideal calculado</div>
                                        </div>
                                        <div className="bg-gradient-to-br from-white to-red-50 p-6 rounded-2xl border border-red-100 shadow-sm relative">
                                            <div className="flex items-center gap-2 mb-1"><IconWrapper name="Zap" className="text-red-500" size={20} /><p className="font-bold text-slate-700">Oferta Relâmpago</p></div>
                                            <p className="text-xs text-slate-400 mb-4">Agressiva (-{Number(descontoPercentual + 1).toFixed(0)}%)</p>
                                            <div className="text-3xl font-bold text-red-500">{formatCurrency(precoRelampago)}</div>
                                            <div className="mt-2 text-xs font-bold text-red-700 bg-red-100 inline-block px-2 py-1 rounded">Lucro Reduzido: {formatCurrency(lucroRelampago)}</div>
                                        </div>
                                    </div>
                                </div>

                                {/* GAMIFICATION */}
                                <div>
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2"><IconWrapper name="TrendingUp" className="text-blue-500" size={24} /> Ajustar por Nível da Loja</h3>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <button onClick={() => aplicarNivel(2)} className={`text-left p-6 rounded-2xl border-2 transition-all hover:shadow-md group ${margemDesejada === 2 ? 'border-orange-400 bg-orange-50' : 'border-slate-200 bg-white hover:border-orange-300'}`}>
                                            <div className="flex items-center gap-3 mb-2">
                                                <div className="p-2 bg-orange-100 rounded-lg"><IconWrapper name="Star" className="text-orange-500" size={20} /></div>
                                                <span className="font-bold text-slate-700 text-lg">Iniciante</span>
                                            </div>
                                            <p className="text-xs text-slate-500 mb-4">Lojas Novas - Margem 2%</p>
                                            <div className="space-y-3 pt-2 border-t border-slate-100">
                                                <div className="flex justify-between"><p className="text-xs text-slate-400">Preço "Por"</p><p className="text-sm font-bold text-slate-700">{formatCurrency(calcularPrecoLucroPorMargem(2).precoVenda)}</p></div>
                                                <div className="flex justify-between"><p className="text-xs text-slate-400">Lucro Líquido</p><p className="text-sm font-bold text-green-600">{formatCurrency(calcularPrecoLucroPorMargem(2).lucroLiquido)}</p></div>
                                            </div>
                                        </button>

                                        <button onClick={() => aplicarNivel(10)} className={`text-left p-6 rounded-2xl border-2 transition-all hover:shadow-md group ${margemDesejada === 10 ? 'border-blue-400 bg-blue-50' : 'border-slate-200 bg-white hover:border-blue-300'}`}>
                                            <div className="flex items-center gap-3 mb-2">
                                                <div className="p-2 bg-blue-100 rounded-lg"><IconWrapper name="Medal" className="text-blue-500" size={20} /></div>
                                                <span className="font-bold text-slate-700 text-lg">Intermediário</span>
                                            </div>
                                            <p className="text-xs text-slate-500 mb-4">30 - 100 Vendas - Margem 10%</p>
                                            <div className="space-y-3 pt-2 border-t border-slate-100">
                                                <div className="flex justify-between"><p className="text-xs text-slate-400">Preço "Por"</p><p className="text-sm font-bold text-slate-700">{formatCurrency(calcularPrecoLucroPorMargem(10).precoVenda)}</p></div>
                                                <div className="flex justify-between"><p className="text-xs text-slate-400">Lucro Líquido</p><p className="text-sm font-bold text-green-600">{formatCurrency(calcularPrecoLucroPorMargem(10).lucroLiquido)}</p></div>
                                            </div>
                                        </button>

                                        <button onClick={() => aplicarNivel(15)} className={`text-left p-6 rounded-2xl border-2 transition-all hover:shadow-md group ${margemDesejada === 15 ? 'border-green-400 bg-green-50' : 'border-slate-200 bg-white hover:border-green-300'}`}>
                                            <div className="flex items-center gap-3 mb-2">
                                                <div className="p-2 bg-green-100 rounded-lg"><IconWrapper name="Trophy" className="text-green-500" size={20} /></div>
                                                <span className="font-bold text-slate-700 text-lg">Avançado</span>
                                            </div>
                                            <p className="text-xs text-slate-500 mb-4">+ 100 Vendas - Margem 15%</p>
                                            <div className="space-y-3 pt-2 border-t border-slate-100">
                                                <div className="flex justify-between"><p className="text-xs text-slate-400">Preço "Por"</p><p className="text-sm font-bold text-slate-700">{formatCurrency(calcularPrecoLucroPorMargem(15).precoVenda)}</p></div>
                                                <div className="flex justify-between"><p className="text-xs text-slate-400">Lucro Líquido</p><p className="text-sm font-bold text-green-600">{formatCurrency(calcularPrecoLucroPorMargem(15).lucroLiquido)}</p></div>
                                            </div>
                                        </button>
                                    </div>
                                </div>

                                {/* ADS E SIMULAÇÃO */}
                                <div className="bg-white rounded-2xl border border-slate-200 p-6 md:p-8 shadow-sm">
                                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                                        <div><h3 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><IconWrapper name="BarChart3" className="text-indigo-500" size={24} /> Inteligência de Tráfego</h3><p className="text-sm text-slate-500">Limites para Shopee Ads e Facebook Ads</p></div>
                                        <div className="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2"><IconWrapper name="Info" size={14} /> Baseado no seu Lucro Líquido</div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                        <div className="border border-orange-200 rounded-xl p-5 bg-white hover:shadow-md transition-all">
                                            <div className="flex items-center gap-2 mb-3"><div className="p-1.5 bg-orange-100 rounded text-orange-600"><IconWrapper name="AlertTriangle" size={16} /></div><span className="font-bold text-slate-700 text-sm uppercase">ROAS Mínimo</span></div>
                                            <div className="text-4xl font-bold text-orange-500 mb-1 tracking-tight">{roasMinimo.toFixed(2)}x</div>
                                            <p className="text-xs text-slate-400">Seu Break-even. Abaixo disso você perde dinheiro.</p>
                                        </div>
                                        <div className="border border-green-200 rounded-xl p-5 bg-gradient-to-b from-green-50 to-white relative overflow-hidden ring-2 ring-green-400 shadow-md transform md:-translate-y-2">
                                            <div className="absolute top-0 right-0 bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-bl-lg">META</div>
                                            <div className="flex items-center gap-2 mb-3"><div className="p-1.5 bg-green-100 rounded text-green-600"><IconWrapper name="Target" size={16} /></div><span className="font-bold text-slate-800 text-sm uppercase">ROAS Ideal</span></div>
                                            <div className="text-4xl font-bold text-green-600 mb-1 tracking-tight">{roasIdeal.toFixed(2)}x</div>
                                            <p className="text-xs text-slate-500">Permite escalar mantendo 50% do lucro no bolso.</p>
                                        </div>
                                        <div className="border border-purple-200 rounded-xl p-5 bg-white hover:shadow-md transition-all">
                                            <div className="flex items-center gap-2 mb-3"><div className="p-1.5 bg-purple-100 rounded text-purple-600"><IconWrapper name="Rocket" size={16} /></div><span className="font-bold text-slate-700 text-sm uppercase">ROAS Excelente</span></div>
                                            <div className="text-4xl font-bold text-purple-500 mb-1 tracking-tight">{roasExcelente.toFixed(2)}x</div>
                                            <p className="text-xs text-slate-400">Alta lucratividade com baixo investimento.</p>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="bg-slate-50 rounded-xl p-4 flex justify-between items-center border border-slate-200">
                                            <div className="flex items-center gap-3"><div className="bg-white p-2 rounded-full border border-slate-100 shadow-sm"><IconWrapper name="DollarSign" className="text-slate-400" size={16} /></div><div><p className="font-bold text-slate-700 text-sm">CPA Máximo (Teto)</p><p className="text-[10px] text-slate-400">Quanto pode pagar por venda</p></div></div>
                                            <div className="text-xl font-bold text-orange-500">{formatCurrency(cpaMaximo)}</div>
                                        </div>
                                        <div className="bg-slate-50 rounded-xl p-4 flex justify-between items-center border border-slate-200">
                                            <div className="flex items-center gap-3"><div className="bg-white p-2 rounded-full border border-slate-100 shadow-sm"><IconWrapper name="Target" className="text-slate-400" size={16} /></div><div><p className="font-bold text-slate-700 text-sm">CPA Ideal (Meta)</p><p className="text-[10px] text-slate-400">Investimento saudável</p></div></div>
                                            <div className="text-xl font-bold text-green-600">{formatCurrency(cpaIdeal)}</div>
                                        </div>
                                    </div>
                                </div>

                                {/* SIMULAÇÕES */}
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><IconWrapper name="SplitSquareHorizontal" className="text-indigo-500" size={20} /> Orgânico vs Ads</h3>
                                        <div className="space-y-4">
                                            <div className="flex items-center justify-between p-3 bg-green-50 rounded-xl border border-green-100">
                                                <div className="flex items-center gap-3"><div className="bg-green-200 p-2 rounded-lg text-green-800"><IconWrapper name="Package" size={16} /></div><div><p className="font-bold text-green-900 text-sm">Venda Orgânica</p><p className="text-[10px] text-green-700">Sem custo de ads</p></div></div>
                                                <div className="text-right"><p className="text-sm font-bold text-green-700">{formatCurrency(lucroLiquido)}</p><p className="text-[10px] text-green-600">Lucro Líquido</p></div>
                                            </div>
                                            <div className="flex items-center justify-between p-3 bg-indigo-50 rounded-xl border border-indigo-100 relative overflow-hidden">
                                                <div className="absolute left-0 top-0 h-full w-1 bg-indigo-500"></div>
                                                <div className="flex items-center gap-3"><div className="bg-indigo-200 p-2 rounded-lg text-indigo-800"><IconWrapper name="Zap" size={16} /></div><div><p className="font-bold text-indigo-900 text-sm">Venda com Ads</p><p className="text-[10px] text-indigo-700">Considerando CPA Ideal</p></div></div>
                                                <div className="text-right"><p className="text-sm font-bold text-indigo-700">{formatCurrency(lucroLiquido - cpaIdeal)}</p><p className="text-[10px] text-indigo-600">Lucro Líquido</p></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><IconWrapper name="Target" className="text-emerald-500" size={20} /> Simulador de Metas</h3>
                                        <div className="grid grid-cols-2 gap-3">
                                            {[1000, 5000, 10000, 20000].map(meta => {
                                                const lucroReal = lucroLiquido - cpaIdeal;
                                                const vendas = lucroReal > 0 ? Math.ceil(meta / lucroReal) : 0;
                                                return (
                                                    <div key={meta} className="border border-slate-100 bg-slate-50 p-3 rounded-xl text-center hover:bg-white hover:shadow-sm transition-all hover:border-emerald-200 group">
                                                        <p className="text-[10px] text-slate-400 uppercase font-bold mb-1">Lucrar {formatCurrency(meta)}</p>
                                                        <div className="text-xl font-extrabold text-emerald-600 group-hover:scale-110 transition-transform inline-block">{vendas}</div>
                                                        <p className="text-[10px] text-emerald-700">vendas necessárias</p>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}

                        {activeTab === 'list' && (
                            <div className="space-y-6">
                                <div className="flex items-center gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                    <IconWrapper name="Search" className="text-slate-400" size={20} />
                                    <input type="text" placeholder="Buscar nos seus produtos..." className="w-full outline-none text-slate-700 font-medium" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {produtosSalvos.filter(p => p.nomeProduto?.toLowerCase().includes(searchTerm.toLowerCase())).map((prod) => (
                                        <div key={prod.id} className="bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all overflow-hidden group relative">
                                            <div className="p-5">
                                                <h3 className="font-bold text-lg text-slate-800 mb-1">{prod.nomeProduto}</h3>
                                                <p className="text-xs text-slate-400 mb-4">Atualizado: {prod.lastUpdated?.seconds ? new Date(prod.lastUpdated.seconds * 1000).toLocaleDateString() : 'Hoje'}</p>
                                                <div className="grid grid-cols-2 gap-4 mb-4">
                                                    <div><p className="text-[10px] text-slate-400 uppercase font-bold">Venda</p><p className="text-xl font-bold text-slate-700">{formatCurrency(prod.summary?.precoVenda || 0)}</p></div>
                                                    <div><p className="text-[10px] text-slate-400 uppercase font-bold">Lucro</p><p className="text-xl font-bold text-emerald-600">{formatCurrency(prod.summary?.lucroLiquido || 0)}</p></div>
                                                </div>
                                                <div className="flex items-center gap-2 pt-4 border-t border-slate-100">
                                                    <button onClick={() => handleEdit(prod)} className="flex-1 flex items-center justify-center gap-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-bold py-2 rounded-lg text-xs transition-colors"><IconWrapper name="Edit" size={14} /> Editar</button>
                                                    <button onClick={(e) => handleDelete(prod.id, e)} className="flex items-center justify-center p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><IconWrapper name="Trash2" size={16} /></button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {produtosSalvos.length === 0 && <div className="col-span-full text-center py-12 text-slate-400"><div className="bg-slate-100 p-4 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"><IconWrapper name="LayoutGrid" size={24} className="opacity-50" /></div><p className="font-medium text-slate-500">Nenhum produto salvo.</p><button onClick={() => setActiveTab('calc')} className="text-orange-500 font-bold mt-2 hover:underline text-sm">Criar o primeiro</button></div>}
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ShopeeCalculator />);
    </script>
</body>
</html>
